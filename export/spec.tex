% Created 2024-07-05 Fri 13:33
% Intended LaTeX compiler: pdflatex
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\usepackage[margin=1in]{geometry}
\author{Gleefre}
\date{\today}
\title{PLN CDR draft: spec}
\hypersetup{
 pdfauthor={Gleefre},
 pdftitle={PLN CDR draft: spec},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 28.2 (Org mode 9.5.5)}, 
 pdflang={English}}
\begin{document}

\maketitle

\section{Introduction}
\label{sec:orged49c1b}
This is a specification for the package-local nicknames extension in Common Lisp.
\subsection{Rationale}
\label{sec:org3ac9dd8}
Package-local nicknames allow to use short and easy-to-use names for packages
locally without potentially introducing name conflict as with normal nicknames.
\subsection{Current state}
\label{sec:orgeda2802}
Package-local nicknames are implemented in some form in \texttt{SBCL}, \texttt{CCL}, \texttt{ECL},
\texttt{Clasp}, \texttt{ABCL}, \texttt{Allegro CL}, \texttt{LispWorks}. There also exists a pending PR for the
\texttt{CLISP} implementation.

Unfortunately, there are multiple inconsistencies between implementations, all
implementations lose the \textbf{print-read} consistency to some extent, and there are
multiple edge cases that aren't always implemented correctly.
\subsection{Goal}
\label{sec:org284158d}
The purpose of this document is to standardize the package-local nicknames
extension and to address some existing issues.

[TODO] This CDR also aims to provide an extensive test suite for this extension.
\section{Description}
\label{sec:org82ea024}
\emph{Package-local nickname} (or \emph{local nickname}) has the same effects as a usual
\emph{package nickname} (later \emph{global nickname}), except that these effects only apply
when \texttt{*package*} is bound to a package for which the nickname has been defined.

That means that calls to \texttt{find-package} with a \emph{local nickname} defined in the
\emph{current package} should return the package nicknamed by this nickname.

This also affects all implied calls to \texttt{find-package}, including those performed by
the lisp reader.

In addition, to maintain \textbf{print-read} consistency, the lisp printer is affected by
\emph{local nicknames} defined in the \emph{current package}.
For details see Issue 2.

\emph{Local nickname} is allowed to shadow a \emph{package name} or a \emph{global nickname},
except for the names \texttt{\#:CL}, \texttt{\#:COMMON-LISP} and \texttt{\#:KEYWORD} which should always
refer to their packages.

The consequences of adding \emph{local nicknames} to the packages \texttt{\#:COMMON-LISP} and
\texttt{\#:KEYWORD} are undefined.
\section{API}
\label{sec:org72b40be}
\subsection{defpackage}
\label{sec:orga7fab27}
\texttt{defpackage} options are extended to include \emph{local-nicknames-option}:
\begin{verbatim}
local-nicknames-option ::= (:local-nicknames (nickname package)*)
\end{verbatim}


Each pair specifies a \emph{local nickname} \texttt{nickname} for the corresponding \texttt{package}.

This option may appear more than once.
\subsubsection{Arguments and Values:}
\label{sec:org8f76976}
\texttt{nickname} must be a \emph{string designator}.

\texttt{package} must be a \emph{package designator}.
\subsubsection{Exceptional situations}
\label{sec:org5ac218c}
An error of type \texttt{package-error} is signaled when a package designated by
\texttt{package} does not exists.

Name conflict errors are handled by the underlying calls to
\texttt{add-package-local-nickname}.

See \hyperref[sec:org4b1c53c]{add-package-local-nickname: exceptional situations}.
\subsubsection{Implementation dependent}
\label{sec:org7983f95}
The behaviour is unspecified when a \emph{local nickname} is specified for the package
that is being defined. (See Issue 4.)

The behaviour is unspecified when supplied \emph{local nicknames} are at variance with
the current state of the package that is being defined. An implementation might
choose to remove all present \emph{local nicknames} at the begining of each
redefinition of the package.
\subsection{make-package}
\label{sec:orgd56e37d}
(\textbf{PROPOSAL}: see Issue 6.)

\texttt{make-package} lambda list is extended to include an additional keyword argument
\texttt{:local-nicknames}:
\begin{verbatim}
local-nicknames ::= ((nickname package)*)
\end{verbatim}


\texttt{local-nicknames} defaults to an \emph{empty list}.

\texttt{local-nicknames} must be a \emph{list} each element of which must be a \emph{list} of form
\texttt{(nickname package)}. Specifies \emph{local nicknames} in the new \emph{package}.
\subsubsection{Arguments and Values:}
\label{sec:org430df28}
\texttt{local-nicknames} must be a a \emph{list} of pairs \texttt{(nickname package)}.

\texttt{nickname} must be a \emph{string designator}.

\texttt{package} must be a \emph{package designator}.
\subsubsection{Exceptional situations}
\label{sec:orgb4df8e7}
An error of type \texttt{package-error} is signaled when a package designated by
\texttt{package} does not exists.

Name conflict errors are handled by the underlying calls to
\texttt{add-package-local-nickname}.

See \hyperref[sec:org4b1c53c]{add-package-local-nickname: exceptional situations}.
\subsubsection{Implementation dependent}
\label{sec:org04eab75}
The behaviour is unspecified when a \emph{local nickname} is specified for the package
that is being defined. (See Issue 4.)
\subsection{add-package-local-nickname}
\label{sec:org3945e27}
\begin{verbatim}
(add-package-local-nickname nickname actual-package &optional designated-package)
  => designated-package-object
\end{verbatim}

\texttt{designated-package} defaults to the \emph{current package}.

Adds a \emph{package-local nickname} \texttt{nickname} for the \texttt{actual-package} in the
\texttt{designated-package}.

Returns the package designated by \texttt{designated-package}. (But also see Issue 1.)

If a \emph{nickname} is already defined, checks that it is defined for the package
designated by \texttt{actual-package}.
\subsubsection{Arguments and Values}
\label{sec:org88a8f1b}
\texttt{nickname} must be a \emph{string designator}.

\texttt{actual-package} and \texttt{designated-package} must be \emph{package designators}.

\texttt{designated-package-object} is of type \emph{package}.
\subsubsection{Exceptional situations}
\label{sec:org4b1c53c}
If a package designated by \texttt{actual-package} or a package designated by
\texttt{designated-package} does not exists, an error of type \emph{package-error}
must be signaled.

If \texttt{nickname} is one of the names \texttt{\#:CL}, \texttt{\#:COMMON-LISP} or \texttt{\#:KEYWORD},
an error of type \emph{package-error} must be signaled.

If \texttt{nickname} is a \emph{local nickname} for a package different from
\texttt{actual-package}, an error of type \emph{package-error} must be signaled.
\subsubsection{Implementation dependent}
\label{sec:org6a16535}
The consequences are undefined when \texttt{designated-package} designates one of the
packages \texttt{\#:COMMON-LISP} or \texttt{\#:KEYWORD}.

(\textbf{PROPOSAL}: see Issue 5.)

If \texttt{nickname} shadows the \texttt{designated-package}'s \emph{package name} or one of its
\emph{global nicknames}, a style warning might signaled.
\subsection{remove-package-local-nickname}
\label{sec:orgb66fe32}
\begin{verbatim}
(remove-package-local-nickname old-nickname &optional designated-package)
  => nickname-removed-p
\end{verbatim}

\texttt{designated-package} defaults to the \emph{current package}.

If \texttt{designated-package} has \texttt{old-nickname} as a \emph{local nickname}, it is removed.

Returns \emph{true} if the \texttt{old-nickname} existed and was removed, and \texttt{NIL}
otherwise. (But also see Issue 1.)
\subsubsection{Arguments and Values}
\label{sec:org8f8a205}
\texttt{old-nickname} must be a \emph{string designator}.

\texttt{designated-package} must be a \emph{package designator}.

\texttt{nickname-removed-p} is a \emph{generalized boolean}.
\subsubsection{Exceptional situations}
\label{sec:orgdb907fc}
If a package designated by \texttt{designated-package} does not exists, an error of type
\emph{package-error} must be signaled.
\subsection{package-local-nicknames}
\label{sec:org1f36083}
\begin{verbatim}
(package-local-nicknames package)
  => local-nicknames-alist
local-nicknames-alist ::= ((nickname . package)*)
\end{verbatim}

Returns an \emph{alist} describing \emph{local nicknames} defined in the package designated
by \texttt{package}.
\subsubsection{Arguments and Values}
\label{sec:org388e6af}
\texttt{package} must be a \emph{package designator}.

\texttt{local-nicknames-alist} is an \emph{alist} with keys of type \emph{string} and values of
type \emph{package}.

\texttt{nickname} must be a \emph{string}.

\texttt{package} must be a \emph{package}.
\subsubsection{Exceptional situations}
\label{sec:org19feabd}
An error of type \texttt{package-error} is signaled when a package designated by
\texttt{package} does not exists.
\subsubsection{Notes}
\label{sec:org5c431c3}
The returned \emph{alist} must be safe to be modified by the user.
\subsection{package-locally-nicknamed-by-list}
\label{sec:org0337449}
\begin{verbatim}
(package-locally-nicknamed-by-list package)
  => packages-list
\end{verbatim}

Returns a \emph{list} of packages that have a \emph{local nickname} defined for the package
designated by \texttt{package}.
\subsubsection{Arguments and Values}
\label{sec:org8b40c82}
\texttt{package} must be a \emph{package designator}.

\texttt{packages-list} is a \emph{list} with elements of type \emph{package}.
\subsubsection{Exceptional situations}
\label{sec:org1d6143c}
An error of type \texttt{package-error} is signaled when a package designated by
\texttt{package} does not exists.
\subsubsection{Notes}
\label{sec:orgd21002e}
The returned \emph{list} must be safe to be modified by the user.
\section{Affected symbols}
\label{sec:org1085be7}
\subsection{defpackage}
\label{sec:org4138e27}
See \hyperref[sec:orga7fab27]{defpackage}.
\subsection{make-package}
\label{sec:org318283f}
See \hyperref[sec:orgd56e37d]{make-package}.
\subsection{find-package}
\label{sec:org1442b6f}
When argument to \texttt{find-package} is a \emph{local nickname} that is defined in the
\emph{current package}, it returns the package named by this nickname.

This also affects all implied calls to \texttt{find-package}, including but not limited
to those performed by the lisp reader as well as those performed by \texttt{export},
\texttt{find-symbol}, \texttt{import}, \texttt{rename-package}, \texttt{shadow}, \texttt{shadowing-import},
\texttt{delete-package}, \texttt{with-package-iterator}, \texttt{unexport}, \texttt{unintern}, \texttt{in-package},
\texttt{unuse-package}, \texttt{use-package}, \texttt{do-symbols}, \texttt{do-external-symbols},
\texttt{do-all-symbols}, \texttt{intern}, \texttt{package-name}, \texttt{package-nicknames},
\texttt{package-shadowing-symbols}, \texttt{package-use-list}, \texttt{package-used-by-list}.

\texttt{add-package-local-nickname}, \texttt{remove-package-local-nickname},
\texttt{package-local-nicknames} and \texttt{package-locally-nicknamed-by} are also affected.

(\textbf{PROPOSAL}: see Issue 8.)

The only exception is the \texttt{format}'s \emph{tilde slash} directive, which should \textbf{not}
use \emph{local nicknames} of any package when looking up the symbol specified.
\subsection{rename-package}
\label{sec:org18f81be}
When a package is renamed with \texttt{rename-package} it maintains all \emph{local nicknames}
it is nicknamed by, as well as all \emph{local nicknames} it has defined.
\subsubsection{Implementation dependent}
\label{sec:org50d244e}
(\textbf{PROPOSAL}: see Issue 5.)

If the \emph{new-name} or one of the \emph{new-nicknames} is shadowed by one of the \emph{local
nicknames} of the package being redefined, a warning might be signaled.
\subsection{delete-package}
\label{sec:org9e84727}
When a package is deleted with \texttt{delete-package} all \emph{local nicknames} defined in
other packages that it was nicknamed by must be removed, as well as all \emph{local
nicknames} defined in the package that is being deleted.

This also means that a deleted package must not be available via calls to
\texttt{package-locally-nicknamed-by-list} and \texttt{package-local-nicknames}.
\subsection{format}
\label{sec:orgefb4a01}
See Issue 8.
\subsection{$\backslash$*features$\backslash$*}
\label{sec:orgd36cf1b}
If an implementation supports package-local nicknames it should add symbols
\texttt{:package-local-nicknames} and \texttt{:cdr-15} (per CDR 14) to \texttt{*features*}.
\section{Examples}
\label{sec:orgc621836}
[TODO]
\end{document}